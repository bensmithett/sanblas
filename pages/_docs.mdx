# San Blas Documentation

San Blas is a [template repo](https://github.blog/2019-06-06-generate-new-repositories-with-repository-templates/), not a library you `npm install` into your existing project.

At its core, San Blas is just [four files](#core-files).

Because they're not hidden away in `node_modules`, you're free to read, understand, hack and extend your project if you want to change anything.

## Getting started

Click the green *Use this template* button [on GitHub](https://github.com/bensmithett/sanblas) and clone your new repo.

Install dependencies: `yarn` (or `npm install`)

San Blas comes with 3 package scripts:

- `yarn storybook` starts Storybook at http://localhost:9000
- `yarn start` builds the site in `development` mode and serves it at http://localhost:5000
- `yarn build` builds the site in `production` mode into the `output` directory

Start Storybook to build and style your `components`, then use them in MDX or JS files in `pages`. When you're ready, `yarn build` and deploy the `output` folder to your favourite static host!

[![Deploy to Netlify](https://www.netlify.com/img/deploy/button.svg)](https://app.netlify.com/start/deploy?repository=https://github.com/bensmithett/sanblas)

## Global configuration

There are 2 config options in the `sanblas` field in `package.json`:

- `feedTitle`: the title of your [JSON Feed](https://jsonfeed.org/)
- `siteURL`: your site's root URL, e.g. `https://example.org`
  - Ensures images have absolute paths so they work in feed readers. It can be left blank if you're not publishing a feed, or if your content doesn't contain images.
  - This is just used as [file-loader's `publicPath`](https://webpack.js.org/loaders/file-loader/#publicpath) in your Webpack config

## Pages

Each JS and MDX file in the `pages` directory is compiled into a HTML file by `entry.prerender.js`.

Each page should export:

- `default`: a React component (JS pages only; MDX pages do this automatically)
- `meta`: *(object)*
  - `title` *(string, required)*
  - `description` *(string, required)*
  - `collection` *(string)*
    - `'posts'` is the only value supported by default
  - `date`: any date string parsable by JS `new Date()` *(string, required if `collection: 'posts'` is set)*

## Components

The React components you build pages with, styled with [Fela](https://fela.js.org/)

**By default, components used in pages are only prerendered.** Any client-side behaviour in your component (e.g. event handlers, timers, `useEffect` hooks or lifecycle methods) will not work in the browser until you [`rehydrate`](https://reactjs.org/docs/react-dom.html#hydrate) the prerendered component.

You can do this with the provided `isomorphic_helpers.js` or DIY manually in `entry.client.js`.

**Isomorphic React is totally optional!** You can add behaviour to your prerendered HTML using vanilla JS, other libraries, or by manually mounting client-only React components.

## Core files

These 4 small files in the `lib` directory are the heart of San Blas. They're heavily commented, so I encourage you to read them, understand what's happening and make changes to suit your needs!

- `build.js`
- `entry.client.js`
- `entry.prerender.js`
- `isomorphic_helpers.js`

### `build.js`

Builds 2 JS bundles from the `entry.prerender.js` and `entry.client.js` entrypoints, then uses the prerender bundle to generate your static site.

### `entry.client.js`

The browser JS bundle loaded by a `<script>` tag on your pages. It enhances your prerendered HTML with client-side JS.

It does the following by default:

- **Rehydrate Fela styles:** If you use Fela in your client bundle (including in any components), you need to [rehydrate](https://fela.js.org/docs/api/fela-dom/rehydrate.html) fela-dom's cache from prerendered styles.
- **Import and rehydrate prerendered components:** See `isomorphic_helpers.js`

### `entry.prerender.js`

This file's default exported function is called by `build.js` in Node to build your site's HTML files and other static assets.

### `isomorphic_helpers.js`

Exports 2 functions:

#### `asIsland`

A [higher-order component](https://reactjs.org/docs/higher-order-components.html) for prerendering components in your pages that will later be rehydrated with the same props on the client.

```js
asIsland(componentName, Component, options)
```

- `componentName`: the name of the component as passed to `rehydrateIslands` *(string, required)*
- `Component`: any React component whose props can be serialised with `JSON.stringify` *(React component, required)*
- `options`: *(object)*
  - `islandTag`: the HTML element to wrap the component with *(string, default: 'div')*
  - `islandProps`: any props to be passed to the island element *(object, default: {})*

#### `rehydrateIslands`

Used by the browser JS bundle to [rehydrate](https://reactjs.org/docs/react-dom.html#hydrate) any components that were prerendered using the `asIsland` higher-order component.

```js
rehydrateIslands(components)
```

- `components`: an object containing the components to be rehydrated, keyed by the `componentName` values used in `asIsland` *(object, required)*

#### Example usage of isomorphic helpers

Export a version of your component wrapped with the `asIsland` higher-order component:

```js
export default function WelcomeBanner ({ alertMessage }) { ... }
export const WelcomeBannerIsland = asIsland('WelcomeBanner', WelcomeBanner)
```

Then, in a page where the component needs client-side behaviour, render the island rather than the original component:

```js
import { WelcomeBannerIsland } from '../components/welcome_banner/welcome_banner'

export default function MyPage () {
  return <>
    ...
    <WelcomeBannerIsland alertMessage='hi' />
    ...
  </>
}
```

Finally, ensure the original component is imported into `entry.client.js` and passed to `rehydrateIslands`:

```js
import WelcomeBanner from '../components/welcome_banner/welcome_banner'
rehydrateIslands({ WelcomeBanner })
```

Your component will appear inside a wrapper tag in your prerendered HTML:

```html
<div
  data-sanblas-hydrate-as='WelcomeBanner'
  data-sanblas-hydrate-with='{\"alertMessage\":\"hi\"}'
>
  ...
</div>
```

This element will be detected by `rehydrateIslands` and your component will be rehydrated with its original props.
